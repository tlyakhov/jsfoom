<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
    <title>jsFoom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Foom"/>
    <meta name="keywords" content="foom"/>
    <meta name="author" content="Tim Lyakhovetskiy"/>

    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
    <link href='http://fonts.googleapis.com/css?family=Cabin:500,500italic,700,700italic' rel='stylesheet'
          type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700' rel='stylesheet' type='text/css'>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="js/game/game_constants.js"></script>
    <script src="js/lib/object_id.js"></script>
    <script src="js/engine/utils.js"></script>
    <script src="js/engine/object_cache.js"></script>
    <script src="js/engine/vector3.js"></script>
    <script src="js/engine/texture.js"></script>
    <script src="js/engine/texture_cache.js"></script>
    <script src="js/engine/material.js"></script>
    <script src="js/engine/map_segment.js"></script>
    <script src="js/engine/map_sector.js"></script>
    <script src="js/engine/map_sector_water.js"></script>
    <script src="js/engine/map_sector_vertical_door.js"></script>
    <script src="js/engine/sprite.js"></script>
    <script src="js/engine/entity.js"></script>
    <script src="js/engine/static_entity.js"></script>
    <script src="js/engine/light_entity.js"></script>
    <script src="js/engine/player.js"></script>
    <script src="js/engine/map.js"></script>
    <script src="js/engine/render_slice.js"></script>
    <script src="js/engine/renderer.js"></script>
    <script src="js/game/game_sprite_sets.js"></script>
    <script src="js/game/test_map.js"></script>
    <script src="js/input.js"></script>
</head>
<body onload="init();" onkeydown="keyDown(event);return false;" onkeyup="keyUp(event); return false;">
<canvas id="renderCanvas" width="640" height="360">
</canvas>
<script>
    var map = testMap;
    var renderer = null;
    var prevTime = new Date().getTime();
    var curTime = new Date().getTime();
    var lastFrameTime = 0;
    var globalCanvas = document.getElementById('renderCanvas');
    var globalCtx = globalCanvas.getContext('2d');
    var globalScreenWidth = $('#renderCanvas').width();
    var globalScreenHeight = $('#renderCanvas').height();
    var globalImgData = globalCtx.createImageData(globalScreenWidth, globalScreenHeight);
    var globalRenderBuffer = new ArrayBuffer(globalImgData.data.length);
    var globalRenderBuffer8 = new Uint8ClampedArray(globalRenderBuffer);
    var globalRenderTarget = new Uint32Array(globalRenderBuffer);
    var globalWorkers = [];
    var globalWorkerId = undefined; // We're not a worker
    var globalWorkerFrame = [];
    var workerTime = [];

    function onTextureLoad(worker, texture) {
        for (var i = 0; i < globalWorkers.length; i++) {
            globalWorkers[i].postMessage({
                type: 'setTextureData',
                texture: texture.serialize(),
                data: texture.data
            });
        }
    }

    function flipBuffers() {
        globalImgData.data.set(globalRenderBuffer8);
        globalCtx.putImageData(globalImgData, 0, 0);

        globalCtx.fillStyle = '#FFF';
        globalCtx.fillText('FPS: ' + Math.round(1000.0 / lastFrameTime), 5, 15);
        globalCtx.fillText('Current sector: ' + map.player.sector.id +
                ', x: ' + Math.round(map.player.pos[0]) +
                ', y: ' + Math.round(map.player.pos[1]) +
                ', z: ' + Math.round(map.player.pos[2]), 5, 25);
        globalCtx.fillText('Health: ' + map.player.health, 5, 35);

        for (var i = 0; i < workerTime.length; i++) {
            globalCtx.fillText('Worker ' + i + ': ' + Math.round(1000.0 / (performance.now() - workerTime[i])), 5, 45 + i * 10);
            workerTime[i] = performance.now();
        }
    }

    function onWorkerMessage(e) {
        var data = e.data;

        if (data.type == 'getTextureData') {
            var tex = textureCache.get(data.texture.src, data.texture.generateMipMaps, data.texture.filter, function (texture) {
                onTextureLoad(e.target, texture);
            });
            if (tex.data.length > 0) {
                onTextureLoad(e.target, tex);
            }
        }
        else if (data.type == 'rendered') {
            var wl = globalScreenWidth / globalWorkers.length;
            var xStart = data.id * wl;
            var xEnd = xStart + wl;

            for (var x = xStart; x < xEnd; x++) {
                for (var y = 0; y < globalScreenHeight; y++) {
                    globalRenderTarget[y * globalScreenWidth + x] = data.data[y * wl + x - xStart];
                }
            }
            globalWorkerFrame[data.id] = true;
        }
    }

    function onWorkerError(e) {
        console.log(e);
    }

    function timer() {
        curTime = performance.now();
        lastFrameTime = (curTime - prevTime);
        prevTime = curTime;

        if (globalWorkers.length == 0) {
            renderer.render(globalRenderTarget);
        }
        else {
            var count = 0;
            var ix = globalWorkerFrame.length;
            while (ix--) {
                if (globalWorkerFrame[ix])
                    count++;
            }

            if (count == globalWorkerFrame.length) {
                flipBuffers();

                var m = map.serialize();

                for (var i = 0; i < globalWorkerFrame.length; i++) {
                    globalWorkerFrame[i] = false;
                }
                for (var i = 0; i < globalWorkerFrame.length; i++) {
                    globalWorkers[i].postMessage({ type: 'render', curTime: curTime, map: m });
                }
            }
        }

        checkInput();

        map.frame(lastFrameTime);
    }

    function init() {

        for (var i = 0; i < GAME_CONSTANTS.renderWorkers; i++) {
            var worker = new Worker('js/engine/render_worker.js');
            worker.onmessage = onWorkerMessage;
            worker.onerror = onWorkerError;
            worker.postMessage({ id: i,
                type: 'init',
                screenWidth: $('#renderCanvas').width(),
                screenHeight: $('#renderCanvas').height(),
                workers: GAME_CONSTANTS.renderWorkers });
            globalWorkers.push(worker);
            globalWorkerFrame.push(true);
            workerTime.push(performance.now());
        }

        if (globalWorkers.length == 0) {
            renderer = new Renderer({ canvas: '#renderCanvas' });
        }

        setInterval(timer, 16);
        //timer();

    }

</script>
<h1>jsFoom Test</h1>

<p>
    Controls:
<ul>
    <li>Walk Forward: <b>W</b></li>
    <li>Walk Backward: <b>S</b></li>
    <li>Turn Left: <b>A</b></li>
    <li>Turn Right: <b>D</b></li>
    <li>Jump: <b>SPACE</b></li>
    <li>Crouch: <b>C</b></li>
</ul>
</p>
</body>
</html>